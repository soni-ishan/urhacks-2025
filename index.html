<!DOCTYPE html>
<html>
<head>
    <title>Indoor Navigation System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            max-width: 500px;
            padding: 10px 80px 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .search-box button {
            position: absolute;
            right: 5px;
            top: 5px;
            padding: 6px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-width: 500px;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .suggestion:hover {
            background: #f5f5f5;
        }
        
        #map {
            position: absolute;
            top: 85px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .set-location-btn {
            position: absolute;
            top: 95px;
            right: 10px;
            z-index: 1000;
            padding: 10px 15px;
            background: white;
            border: 2px solid #2196F3;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: #2196F3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .set-location-btn:hover {
            background: #2196F3;
            color: white;
        }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            max-width: 300px;
            display: none;
            z-index: 1000;
        }
        
        .info-panel.show {
            display: block;
        }
        
        .info-panel h3 {
            color: #2196F3;
            margin-bottom: 8px;
        }
        
        .info-panel button {
            margin-top: 10px;
            padding: 8px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        
        .info-panel button:hover {
            background: #1976D2;
        }
        
        .btn-close {
            background: #757575 !important;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Indoor Navigation System with Smart Pathfinding</h1>
        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search location..."
                autocomplete="off"
            >
            <button onclick="search()">üîç Search</button>
            <div class="suggestions" id="suggestions"></div>
        </div>
    </div>
    
    <button class="set-location-btn" onclick="setCurrentLocation()">
        üìç Set My Location
    </button>
    
    <div id="map"></div>
    
    <div class="info-panel" id="infoPanel">
        <h3 id="locationName">Location</h3>
        <p id="locationDesc">Description</p>
        <button onclick="navigateTo()">üß≠ Navigate Here</button>
        <button class="btn-close" onclick="closeInfo()">Close</button>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // YOUR 4 LOCATIONS WITH EXACT DOOR POSITIONS
        const locations = {
            'Main Entrance': {
                pos: [820, 1695],
                door: [1112, 1685],  // Your Location 3
                description: 'Main building entrance'
            },
            'Conference Room': {
                pos: [1992, 1955],
                door: [1907, 2113],  // Your Location 4
                description: 'Meeting and conference space'
            },
            'Computer Lab': {
                pos: [1192, 3195],
                door: [1069, 3106],  // Your Location 1
                description: 'Computer lab with workstations'
            },
            'Study Area': {
                pos: [696, 3243],
                door: [808, 3094],   // Your Location 2
                description: 'Quiet study space'
            }
        };
        
        // CORRIDOR WAYPOINTS (navigable hallway points)
        // These are the main open areas where you can walk
        const corridorWaypoints = [
            // Main hallway spine
            [1100, 2000],
            [1100, 2400],
            [1100, 2800],
            [900, 3000],
            
            // Add more by clicking your hallways and updating this list
            // To add: Click hallway, check console, add coordinate here
        ];
        
        // Map setup
        const map = L.map('map', { 
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 4,
            zoom: 0
        });
        
        const bounds = [[0, 0], [3024, 4032]];
        L.imageOverlay('blueprint.png', bounds).addTo(map);
        map.fitBounds(bounds);
        
        // Variables
        let markers = {};
        let selectedLocation = null;
        let currentLocation = null;
        let currentLocationMarker = null;
        let routeLine = null;
        
        // Add markers at room centers
        Object.entries(locations).forEach(([name, data]) => {
            const marker = L.marker(data.pos).addTo(map);
            marker.bindPopup(`<b>${name}</b><br>${data.description}`);
            marker.on('click', () => showInfo(name, data));
            markers[name] = marker;
            
            // Also add small door marker (optional - for visualization)
            L.circleMarker(data.door, {
                radius: 5,
                fillColor: '#4CAF50',
                color: 'white',
                weight: 2,
                fillOpacity: 0.8
            }).addTo(map).bindPopup(`üö™ Door to ${name}`);
        });
        
        // Calculate distance between two points
        function distance(p1, p2) {
            const dy = p2[0] - p1[0];
            const dx = p2[1] - p1[1];
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // SMART PATHFINDING ALGORITHM
        function findSmartPath(start, destinationName) {
            const destination = locations[destinationName];
            const destDoor = destination.door;
            const destPos = destination.pos;
            
            const path = [start];
            
            // Step 1: From start to nearest corridor waypoint
            let nearestToStart = corridorWaypoints[0];
            let minDist = distance(start, nearestToStart);
            
            corridorWaypoints.forEach(wp => {
                const dist = distance(start, wp);
                if (dist < minDist) {
                    minDist = dist;
                    nearestToStart = wp;
                }
            });
            
            path.push(nearestToStart);
            
            // Step 2: Navigate through corridors to get close to destination door
            let nearestToDoor = corridorWaypoints[0];
            minDist = distance(destDoor, nearestToDoor);
            
            corridorWaypoints.forEach(wp => {
                const dist = distance(destDoor, wp);
                if (dist < minDist) {
                    minDist = dist;
                    nearestToDoor = wp;
                }
            });
            
            // Add intermediate corridor points for more realistic path
            if (nearestToDoor !== nearestToStart) {
                // Simple: connect the two corridor points
                // For better paths, add more waypoints between them
                path.push(nearestToDoor);
            }
            
            // Step 3: Go to door
            path.push(destDoor);
            
            // Step 4: Enter room to final destination
            path.push(destPos);
            
            return path;
        }
        
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const suggestionsDiv = document.getElementById('suggestions');
        
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const matches = Object.keys(locations).filter(name => 
                name.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches.map(name => 
                    `<div class="suggestion" onclick="selectLocation('${name}')">${name}</div>`
                ).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                suggestionsDiv.style.display = 'none';
            }
        });
        
        function search() {
            const query = searchInput.value.trim().toLowerCase();
            const found = Object.keys(locations).find(name => 
                name.toLowerCase().includes(query)
            );
            
            if (found) {
                selectLocation(found);
            } else {
                alert('Location not found! Try: ' + Object.keys(locations).join(', '));
            }
        }
        
        function selectLocation(name) {
            const location = locations[name];
            map.setView(location.pos, 2);
            markers[name].openPopup();
            showInfo(name, location);
            suggestionsDiv.style.display = 'none';
            searchInput.value = name;
            selectedLocation = { name, ...location };
        }
        
        function showInfo(name, data) {
            document.getElementById('locationName').textContent = name;
            document.getElementById('locationDesc').textContent = data.description;
            document.getElementById('infoPanel').classList.add('show');
            selectedLocation = { name, ...data };
        }
        
        function closeInfo() {
            document.getElementById('infoPanel').classList.remove('show');
        }
        
        // Set current location
        function setCurrentLocation() {
            alert('Click on the map where you are currently located');
            
            map.once('click', function(e) {
                currentLocation = [e.latlng.lat, e.latlng.lng];
                
                if (currentLocationMarker) {
                    map.removeLayer(currentLocationMarker);
                }
                
                currentLocationMarker = L.circleMarker(currentLocation, {
                    radius: 12,
                    fillColor: '#2196F3',
                    color: 'white',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
                
                currentLocationMarker.bindPopup('<b>üìç You are here</b>').openPopup();
                console.log('Current location set:', currentLocation);
            });
        }
        
        // SMART NAVIGATION WITH PATHFINDING
        function navigateTo() {
            if (!selectedLocation) {
                alert('Please select a destination first!');
                return;
            }
            
            if (!currentLocation) {
                alert('‚ö†Ô∏è Please set your current location first!\n\nClick "Set My Location" button.');
                return;
            }
            
            if (routeLine) {
                map.removeLayer(routeLine);
            }
            
            // Find smart path avoiding walls
            const smartPath = findSmartPath(currentLocation, selectedLocation.name);
            
            // Draw the route
            routeLine = L.polyline(smartPath, {
                color: '#2196F3',
                weight: 6,
                opacity: 0.9,
                dashArray: '15, 10',
                lineJoin: 'round'
            }).addTo(map);
            
            routeLine.bindPopup(`
                <b>Smart Route to ${selectedLocation.name}</b><br>
                ${smartPath.length} waypoints<br>
                Avoids walls, goes through doors
            `);
            
            map.fitBounds(smartPath, { padding: [80, 80], maxZoom: 2 });
            
            alert(`üß≠ Smart Navigation Active!\n\nDestination: ${selectedLocation.name}\n\n‚úÖ Route goes through corridors\n‚úÖ Enters through door\n‚úÖ Avoids walls\n\nFollow the BLUE line!`);
            
            console.log('Smart path waypoints:', smartPath);
        }
        
        // Click for coordinates (for adding more corridor waypoints)
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);
            console.log('Position:', y, x);
            console.log('Add to corridorWaypoints: [' + y + ', ' + x + '],');
        });
        
        console.log('‚úÖ Smart Navigation System Ready!');
        console.log('üìç 4 locations with door positions configured');
        console.log('üö™ Doors:', Object.values(locations).map(l => l.door));
    </script>
</body>
</html>
